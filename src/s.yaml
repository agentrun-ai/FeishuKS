edition: 3.0.0
name: feishu-knowledge-sync

# 访问凭证配置
access: "{{ access }}"

vars:
  # 基础配置
  region: "{{ region }}"
  runtime: python3.12
  timeout: 300
  memorySize: 512
  role: "{{ roleArn }}"
  
  # 飞书配置
  feishu:
    appId: "{{ feishuAppId }}"
    appSecret: "{{ feishuAppSecret }}"
    wikiSpaceName: "{{ wikiSpaceName }}"
  
  # OSS配置
  oss:
    endpoint: https://oss-${vars.region}.aliyuncs.com
    bucketName: "{{ ossBucketName }}"
    prefix: "{{ ossPrefix }}"
  
  # AnalyticDB配置
  gpdb:
    instanceId: "{{ gpdbInstanceId }}"
    collection: "{{ gpdbCollection }}"
    namespace: "{{ gpdbNamespace }}"
    namespacePassword: "{{ gpdbNamespacePassword }}"

resources:
  # ========================================
  # 服务1: 飞书到OSS同步服务
  # ========================================
  feishu-to-oss:
    component: fc3
    props:
      region: ${vars.region}
      functionName: feishu-to-oss
      description: 飞书知识库同步到OSS的定时任务函数
      runtime: ${vars.runtime}
      code: ./feishu-to-oss
      handler: index.handler
      memorySize: ${vars.memorySize}
      timeout: ${vars.timeout}
      role: ${vars.role}
      internetAccess: true
      logConfig: auto
      
      # 环境变量
      environmentVariables:
        FEISHU_APP_ID: ${vars.feishu.appId}
        FEISHU_APP_SECRET: ${vars.feishu.appSecret}
        WIKI_SPACE_NAME: ${vars.feishu.wikiSpaceName}
        OSS_ENDPOINT: ${vars.oss.endpoint}
        OSS_BUCKET_NAME: ${vars.oss.bucketName}
        OSS_PREFIX: ${vars.oss.prefix}
      
      # 触发器配置
      triggers:
        - triggerName: timer-trigger
          triggerType: timer
          description: 定时同步飞书知识库
          triggerConfig:
            cronExpression: "{{ cronExpression }}"
            enable: true
            payload: '{"type": "scheduled"}'

  # ========================================
  # 服务2: OSS到知识库同步服务
  # ========================================
  oss-to-kb:
    component: fc3
    actions:
      pre-deploy:
        - run: pip install -r requirements.txt -t .
          path: ./oss-to-kb
        - run: echo "依赖安装完成"
          path: ./
    props:
      region: ${vars.region}
      functionName: oss-to-kb
      description: OSS文件变更触发的AnalyticDB知识库同步函数
      runtime: ${vars.runtime}
      code: ./oss-to-kb
      handler: index.handler
      memorySize: ${vars.memorySize}
      timeout: ${vars.timeout}
      role: ${vars.role}
      internetAccess: true
      logConfig: auto
      
      # 环境变量
      environmentVariables:
        GPDB_INSTANCE_ID: ${vars.gpdb.instanceId}
        GPDB_REGION_ID: ${vars.region}
        GPDB_COLLECTION: ${vars.gpdb.collection}
        GPDB_NAMESPACE: ${vars.gpdb.namespace}
        GPDB_NAMESPACE_PASSWORD: ${vars.gpdb.namespacePassword}
        OSS_TRIGGER_BUCKET: ${vars.oss.bucketName}
        OSS_PREFIX_FILTER: ${vars.oss.prefix}
      
      # 触发器配置
      triggers:
        - triggerName: oss-trigger
          triggerType: oss
          description: OSS文件变更触发知识库同步
          triggerConfig:
            bucketName: ${vars.oss.bucketName}
            events:
              - oss:ObjectCreated:PutObject
              - oss:ObjectCreated:PostObject
              - oss:ObjectCreated:CompleteMultipartUpload
              - oss:ObjectCreated:PutSymlink
            filter:
              key:
                prefix: ${vars.oss.prefix}
                suffix: ""
